<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App</title>
    <style>
      .chat {
        display: flex;
        flex-direction: column;
        height: 80vh; /* チャットエリアの高さを調整 */
      }
      .messages {
        flex: 1;
        overflow-y: auto;
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .form {
        display: flex;
      }
      .input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
      }
      .submit {
        padding: 10px;
        border: 1px solid #ccc;
        background: #eee;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="chat">
      <ul class="messages"></ul>
      <form class="form">
        <input class="input" autocomplete="off" />
        <button class="submit">Send</button>
      </form>
    </div>
    <canvas
      id="canvas"
      width="600"
      height="600"
      style="border: solid 1px black"
    ></canvas>

    <script>
      function main() {
        // WebSocket接続を確立
        const host = location.origin.replace(/^http/, 'ws')
        const ws = new WebSocket(host + '/ws')
        // ユニークなIDを生成（チャットでの表示用）
        const myId = self.crypto.randomUUID().substr(0, 8)

        // Canvas要素と2Dコンテキストを取得
        const canvas = document.getElementById('canvas')
        const ctx = canvas.getContext('2d')

        let drawing = false // 描画中かどうかを示すフラグ

        // Canvasイベントリスナー: マウスダウンでお絵かき開始メッセージを送信
        canvas.addEventListener('mousedown', (e) => {
          sendDrawingEvent(e.offsetX, e.offsetY, 'mousedown')
        })
        function mousedown() {
          drawing = true
          ctx.beginPath() // 新しいパスを開始
        }

        // Canvasイベントリスナー: マウス移動中にお絵かき座標メッセージを送信
        canvas.addEventListener('mousemove', (e) => {
          if (drawing) {
            sendDrawingEvent(e.offsetX, e.offsetY, 'mousemove')
          }
        })
        function mousemove(x, y) {
          if (drawing) {
            draw(x, y, true) // 描画処理を実行
          }
        }

        // Canvasイベントリスナー: マウスアップでお絵かき終了メッセージを送信
        canvas.addEventListener('mouseup', (e) => {
          sendDrawingEvent(e.offsetX, e.offsetY, 'mouseup')
        })
        function mouseup() {
          drawing = false
          ctx.beginPath() // パスを閉じる（または新しいパスを開始）
        }

        // Canvasイベントリスナー: マウスがCanvasから外れたときにお絵かき終了メッセージを送信
        canvas.addEventListener('mouseout', (e) => {
          sendDrawingEvent(e.offsetX, e.offsetY, 'mouseout')
        })
        function mouseout() {
          drawing = false
        }

        // 描画処理関数
        function draw(x, y, dragging) {
          if (dragging) {
            ctx.lineTo(x, y) // 現在の点から指定された点まで線を引く
            ctx.stroke() // 現在のパスを描画
          } else {
            ctx.moveTo(x, y) // 新しいサブパスの開始点
          }
        }

        // 描画イベントをWebSocket経由で送信する関数
        function sendDrawingEvent(x, y, control) {
          const message = JSON.stringify({ x, y, control, type: 'paint' })
          ws.send(message)
        }

        // WebSocketからメッセージを受信したときの処理
        ws.onmessage = (event) => {
          const msg = JSON.parse(event.data) // 受信したJSON文字列をパース

          if (msg.type === 'paint') {
            // ペイントメッセージの場合
            const { x, y, control } = msg
            console.log({ control })
            if (control === 'mousedown') {
              mousedown()
            } else if (control === 'mouseup') {
              mouseup()
            } else if (control === 'mousemove') {
              mousemove(x, y)
            } else if (control === 'mouseout') {
              mouseout()
            }
          }
          if (msg.type === 'chat') {
            // チャットメッセージの場合
            const { id, text } = msg
            const messageList = document.querySelector('.messages')
            const li = document.createElement('li')
            if (id === myId) {
              li.textContent = `(${id})自分:` + text // 自分のメッセージ
            } else {
              li.textContent = id + ': ' + text // 他のユーザーのメッセージ
            }
            messageList.appendChild(li) // メッセージリストに追加
          }
        }

        // チャットフォームの処理
        const form = document.querySelector('.form')
        form.onsubmit = function (e) {
          e.preventDefault() // フォームのデフォルト送信を防ぐ
          const input = document.querySelector('.input')
          const text = input.value
          // チャットメッセージをJSON形式で送信
          ws.send(JSON.stringify({ id: myId, text, type: 'chat' }))
          input.value = '' // 入力欄をクリア
          input.focus() // 入力欄にフォーカスを戻す
        }

        // WebSocketエラー発生時の処理
        ws.onerror = function (error) {
          console.error('WebSocket Error: ', error)
        }
      }

      main()
    </script>
  </body>
</html>